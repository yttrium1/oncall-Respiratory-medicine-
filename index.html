// 既存HTMLファイルに追加するJavaScript
// <script>タグ内の最後に追加してください

// 提出状況管理クラス（既存スプレッドシート対応版）
class SubmissionTracker {
  constructor() {
    // Google Apps Script のWebアプリURL（デプロイ後に取得したURLに変更）
    this.API_URL = 'https://script.google.com/macros/s/AKfycbyjoymzGDJGP_hlhFn4bI2Mp4mex_fbtJlGEtdWN3KvjIyN-qSTHaouaAFt5QeoJTA/exec';
    this.isLoading = false;
    this.pollInterval = null; // 定期更新用
  }

  // 提出済み医師リストを取得
  async getSubmittedDoctors() {
    if (this.isLoading) return [];
    
    try {
      this.isLoading = true;
      console.log('提出状況を取得中...');
      
      const response = await fetch(`${this.API_URL}?action=getSubmitted&timestamp=${Date.now()}`);
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      console.log('提出状況データ:', data);
      
      return data.submitted || [];
    } catch (error) {
      console.error('提出状況取得エラー:', error);
      return [];
    } finally {
      this.isLoading = false;
    }
  }

  // 提出を記録（B列に追加）
  async recordSubmission(doctorName) {
    if (this.isLoading) return { success: false };
    
    try {
      this.isLoading = true;
      console.log('提出を記録中:', doctorName);
      
      const response = await fetch(this.API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          action: 'recordSubmission',
          doctor: doctorName
        })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const result = await response.json();
      console.log('提出記録結果:', result);
      
      return result;
    } catch (error) {
      console.error('提出記録エラー:', error);
      return { success: false, error: error.toString() };
    } finally {
      this.isLoading = false;
    }
  }

  // 名前選択肢をリアルタイム更新
  async updateNameOptions() {
    try {
      const submittedDoctors = await this.getSubmittedDoctors();
      const nameSelect = document.getElementById('name-select');
      
      if (!nameSelect) return;
      
      // 全ての option 要素を更新
      const options = nameSelect.querySelectorAll('option');
      
      options.forEach(option => {
        if (option.value && option.value !== 'その他') {
          const doctorName = option.value;
          
          // 既存の「（提出済み）」表示をリセット
          let originalText = option.textContent;
          if (originalText.includes('（提出済み）')) {
            originalText = originalText.replace('（提出済み）', '');
          }
          option.textContent = originalText;
          option.style.color = '';
          option.style.fontStyle = '';
          
          // 提出済みかチェック（呼び捨て名で照合）
          if (submittedDoctors.includes(doctorName)) {
            // 提出済みの場合、「（提出済み）」を追加
            option.textContent = originalText.replace('先生', '先生（提出済み）');
            option.style.color = '#94a3b8'; // グレーアウト
            option.style.fontStyle = 'italic';
          }
        }
      });
      
      // 提出済み状況をページに表示
      this.displaySubmissionStatus(submittedDoctors);
      
      console.log('提出済み医師リスト更新完了:', submittedDoctors);
    } catch (error) {
      console.error('名前選択肢更新エラー:', error);
    }
  }

  // 提出状況を画面に表示
  displaySubmissionStatus(submittedDoctors) {
    // 既存の状況表示を削除
    const existingStatus = document.getElementById('submission-status');
    if (existingStatus) {
      existingStatus.remove();
    }
    
    if (submittedDoctors.length > 0) {
      const statusDiv = document.createElement('div');
      statusDiv.id = 'submission-status';
      statusDiv.style.cssText = `
        margin-top: 1rem;
        padding: 0.75rem 1rem;
        background-color: #f0f9ff;
        border: 1px solid #0ea5e9;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        color: #0c4a6e;
      `;
      
      statusDiv.innerHTML = `
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
          <i class="fas fa-info-circle"></i>
          <strong>提出状況</strong>
          <span style="margin-left: auto; font-size: 0.75rem;">${new Date().toLocaleTimeString()}</span>
        </div>
        <div>提出済み（${submittedDoctors.length}名）: ${submittedDoctors.join('、')}</div>
      `;
      
      // 名前選択の下に挿入
      const nameSelect = document.getElementById('name-select');
      nameSelect.parentNode.appendChild(statusDiv);
    }
  }

  // 手動更新ボタンを追加
  addRefreshButton() {
    const nameSelectGroup = document.getElementById('name-select').parentNode;
    
    // 既存のボタンを削除
    const existingButton = document.getElementById('refresh-submission-btn');
    if (existingButton) {
      existingButton.remove();
    }
    
    const refreshButton = document.createElement('button');
    refreshButton.id = 'refresh-submission-btn';
    refreshButton.type = 'button';
    refreshButton.innerHTML = '<i class="fas fa-sync-alt"></i> 提出状況を更新';
    refreshButton.style.cssText = `
      margin-top: 0.75rem;
      padding: 0.5rem 1rem;
      background-color: #f8fafc;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.1s ease;
      width: 100%;
    `;
    
    refreshButton.addEventListener('click', async () => {
      const icon = refreshButton.querySelector('i');
      const originalText = refreshButton.innerHTML;
      
      try {
        refreshButton.disabled = true;
        refreshButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 更新中...';
        
        await this.updateNameOptions();
        
        refreshButton.innerHTML = '<i class="fas fa-check"></i> 更新完了';
        refreshButton.style.backgroundColor = '#f0fdf4';
        refreshButton.style.borderColor = '#22c55e';
        refreshButton.style.color = '#166534';
        
        setTimeout(() => {
          refreshButton.innerHTML = originalText;
          refreshButton.style.backgroundColor = '#f8fafc';
          refreshButton.style.borderColor = 'var(--border)';
          refreshButton.style.color = 'var(--text-secondary)';
          refreshButton.disabled = false;
        }, 2000);
      } catch (error) {
        refreshButton.innerHTML = '<i class="fas fa-exclamation-triangle"></i> エラー';
        refreshButton.style.backgroundColor = '#fef2f2';
        refreshButton.style.borderColor = '#ef4444';
        refreshButton.style.color = '#dc2626';
        
        setTimeout(() => {
          refreshButton.innerHTML = originalText;
          refreshButton.style.backgroundColor = '#f8fafc';
          refreshButton.style.borderColor = 'var(--border)';
          refreshButton.style.color = 'var(--text-secondary)';
          refreshButton.disabled = false;
        }, 3000);
      }
    });
    
    nameSelectGroup.appendChild(refreshButton);
  }

  // リアルタイム更新を開始
  startRealtimeUpdates() {
    // 2分ごとに自動更新
    this.pollInterval = setInterval(async () => {
      console.log('定期更新実行中...');
      await this.updateNameOptions();
    }, 2 * 60 * 1000); // 2分間隔
    
    console.log('リアルタイム更新を開始しました（2分間隔）');
  }

  // リアルタイム更新を停止
  stopRealtimeUpdates() {
    if (this.pollInterval) {
      clearInterval(this.pollInterval);
      this.pollInterval = null;
      console.log('リアルタイム更新を停止しました');
    }
  }
}

// 既存のDOMContentLoadedイベントリスナーを修正
document.addEventListener('DOMContentLoaded', function() {
  // 既存のコードの最初に追加
  
  // 提出状況トラッカーを初期化
  const submissionTracker = new SubmissionTracker();
  
  // 手動更新ボタンを追加
  submissionTracker.addRefreshButton();
  
  // ページ読み込み時に提出状況を確認（3秒後に実行）
  setTimeout(async () => {
    await submissionTracker.updateNameOptions();
  }, 3000);
  
  // リアルタイム更新を開始
  submissionTracker.startRealtimeUpdates();
  
  // ページを離れる時にリアルタイム更新を停止
  window.addEventListener('beforeunload', () => {
    submissionTracker.stopRealtimeUpdates();
  });
  
  // 既存の送信ボタンのイベントリスナーを修正
  // submitBtn.addEventListener('click', function(e) { の部分を以下のように修正：
  
  submitBtn.addEventListener('click', async function(e) {
    e.preventDefault();

    // 1) 名前チェック（既存コード）
    let name = nameSelect.value;
    if (name === 'その他') {
      name = otherNameInput.value.trim();
    }
    if (!name) {
      nameError.style.display = 'block';
      return;
    } else {
      nameError.style.display = 'none';
    }

    // 2) 日直・当直チェック（既存コード）
    let dutyType = dutyTypeSelect.value;
    if (!dutyType) {
      dutyTypeError.style.display = 'block';
      dutyTypeSelect.focus();
      return;
    } else {
      dutyTypeError.style.display = 'none';
    }

    // カレンダー選択結果（既存コード）
    const comment = document.getElementById('comment-input').value.trim();
    const preferredDates = Array.from(document.querySelectorAll('.preferred .selected'))
                                .map(el => el.getAttribute('data-date'));
    const notPreferredDates = Array.from(document.querySelectorAll('.not-preferred .selected'))
                                   .map(el => el.getAttribute('data-date'));
    const email = document.getElementById('email-input').value.trim();

    // 紙飛行機アイコンを飛ばす（既存コード）
    planeIcon.classList.add('flying');

    // 飛行アニメーション完了後に送信処理（既存コードを修正）
    planeIcon.addEventListener('animationend', handleSubmission, { once: true });

    async function handleSubmission() {
      // ボタンを無効化 & スピナー表示
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 送信中...';

      try {
        // EmailJS送信（既存コード）
        const response = await emailjs.send("service_v7cenku", "template_rm69kao", {
          name,
          comment,
          duty_type: dutyType,
          preferred_dates: preferredDates.join(', '),
          not_preferred_dates: notPreferredDates.join(', '),
          email
        });

        // 送信成功時の処理
        console.log('EmailJS送信成功:', response);
        
        // スプレッドシートのB列に提出者を記録
        try {
          await submissionTracker.recordSubmission(name);
          console.log('スプレッドシート記録完了:', name);
          
          // 即座に提出状況を更新
          setTimeout(async () => {
            await submissionTracker.updateNameOptions();
          }, 1000);
        } catch (recordError) {
          console.warn('スプレッドシート記録エラー（メール送信は成功）:', recordError);
        }

        // 既存の成功表示（既存コード）
        submitBtn.style.display = 'none';
        successMessage.classList.add('show');
        
        setTimeout(() => {
          alert(
            `送信が完了しました。\n\n` +
            `回答者：${name}\n` +
            `希望(日)：${preferredDates.join(', ')}\n` +
            `希望しない日：${notPreferredDates.join(', ')}\n` +
            `日直／当直：${dutyType}`
          );
          
          // 初期状態に戻す（既存コード）
          setTimeout(() => {
            planeIcon.classList.remove('flying');
            submitBtn.style.display = 'flex';
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane plane-icon"></i> 送信する';
            successMessage.classList.remove('show');
          }, 2000);
        }, 500);

      } catch (error) {
        // エラー時（既存コード）
        console.error('EmailJS送信エラー:', error);
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> エラー';
        alert('送信に失敗しました。もう一度お試しください。');
        setTimeout(() => {
          planeIcon.classList.remove('flying');
          submitBtn.innerHTML = '<i class="fas fa-paper-plane plane-icon"></i> 送信する';
        }, 3000);
      }
    }
  });
  
  // 既存のコードはここに続く...
});
